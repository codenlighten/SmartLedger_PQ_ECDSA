<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Primary Meta Tags -->
  <title>SmartLedger PQ SDK - Browser Demo</title>
  <meta name="title" content="SmartLedger PQ - Post-Quantum Cryptography SDK" />
  <meta name="description" content="Explore and test SmartLedger's stateless post-quantum cryptographic SDK with interactive key generation, signing, and verification demos. Quantum-resistant security for enterprise and government." />

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="SmartLedger PQ - Post-Quantum Cryptography SDK" />
  <meta property="og:description" content="Explore and test SmartLedger's stateless post-quantum cryptographic SDK with interactive key generation, signing, and verification demos. Quantum-resistant security for enterprise and government." />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="SmartLedger PQ - Post-Quantum Cryptography SDK" />
  <meta name="twitter:description" content="Explore and test SmartLedger's stateless post-quantum cryptographic SDK with interactive key generation, signing, and verification demos. Quantum-resistant security for enterprise and government." />

  <!-- Additional Meta Tags -->
  <meta name="keywords" content="post-quantum cryptography, SmartLedger, quantum-safe, quantum-resistant, cryptographic SDK, key generation, digital signatures, SLPQ, enterprise security" />
  <meta name="author" content="SmartLedger.Technology" />
  <meta name="theme-color" content="#3498db" />
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #2c3e50;
      border-bottom: 3px solid #3498db;
      padding-bottom: 10px;
    }
    h2 {
      color: #34495e;
      margin-top: 30px;
    }
    .demo-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    button {
      background: #3498db;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
    }
    button:hover {
      background: #2980b9;
    }
    button:disabled {
      background: #95a5a6;
      cursor: not-allowed;
    }
    .output {
      background: #2c3e50;
      color: #ecf0f1;
      padding: 15px;
      border-radius: 5px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .success {
      color: #2ecc71;
      font-weight: bold;
    }
    .error {
      color: #e74c3c;
      font-weight: bold;
    }
    .info {
      color: #3498db;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .stat-card {
      background: #ecf0f1;
      padding: 15px;
      border-radius: 5px;
      text-align: center;
    }
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #3498db;
    }
    .stat-label {
      font-size: 12px;
      color: #7f8c8d;
      margin-top: 5px;
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <h1>üîê SmartLedger PQ SDK - Browser Demo</h1>
  <p>Full cryptographic SDK with ECDSA and ML-DSA (Post-Quantum) support running entirely in your browser. Quantum-resistant security for enterprise and government.</p>

  <div class="stats">
    <div class="stat-card">
      <div class="stat-value" id="bundle-size">230.5 KB</div>
      <div class="stat-label">Bundle Size (minified)</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="keys-created">0</div>
      <div class="stat-label">Keys Created</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="signatures-created">0</div>
      <div class="stat-label">Signatures Created</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="verifications">0</div>
      <div class="stat-label">Verifications</div>
    </div>
  </div>

  <div class="demo-section">
    <h2>1. Initialize SDK</h2>
    <button id="init-btn" onclick="initializeSDK()">Initialize SDK</button>
    <div id="init-output" class="output" style="margin-top: 10px;">Click "Initialize SDK" to start...</div>
  </div>

  <div class="demo-section">
    <h2>2. Create Keys</h2>
    <button id="create-ecdsa-btn" onclick="createECDSAKey()" disabled>Create ECDSA Key (Bitcoin)</button>
    <div style="margin: 10px 0;">
      <label for="ml-dsa-variant">ML-DSA Variant:</label>
      <select id="ml-dsa-variant">
        <option value="ml-dsa-44">ML-DSA-44 (Level 2, fastest, smallest signatures)</option>
        <option value="ml-dsa-65" selected>ML-DSA-65 (Level 3, balanced - recommended)</option>
        <option value="ml-dsa-87">ML-DSA-87 (Level 5, maximum security)</option>
      </select>
    </div>
    <button id="create-mldsa-btn" onclick="createMLDSAKey()" disabled>Create ML-DSA Key (Post-Quantum)</button>
    <div id="keys-output" class="output" style="margin-top: 10px;">Initialize SDK first...</div>
  </div>

  <div class="demo-section">
    <h2>3. Sign & Verify</h2>
    <button id="sign-verify-btn" onclick="signAndVerify()" disabled>Sign & Verify Message</button>
    <button id="sign-all-btn" onclick="signWithBoth()" disabled>Sign with Both Algorithms</button>
    <div id="sign-output" class="output" style="margin-top: 10px;">Create keys first...</div>
  </div>

  <div class="demo-section">
    <h2>4. Sign Custom Message</h2>
    <div style="margin: 10px 0;">
      <label for="custom-message">Your Message:</label><br>
      <textarea id="custom-message" placeholder="Enter any text you want to sign..." style="width: 100%; min-height: 80px; padding: 10px; border: 1px solid #bdc3c7; border-radius: 5px; font-family: inherit;" disabled></textarea>
      <p style="font-size: 12px; color: #7f8c8d; margin-top: 5px;" id="message-length">0 characters ‚Ä¢ 0 bytes</p>
    </div>
    <div style="margin: 10px 0;">
      <label>Algorithm:</label><br>
      <button id="algo-ecdsa-btn" onclick="selectAlgorithm('ecdsa')" disabled style="background: #95a5a6;">ECDSA Only</button>
      <button id="algo-mldsa-btn" onclick="selectAlgorithm('mldsa')" disabled style="background: #95a5a6;">ML-DSA Only</button>
      <button id="algo-both-btn" onclick="selectAlgorithm('both')" disabled style="background: #9b59b6;">Both Algorithms</button>
    </div>
    <button id="sign-custom-btn" onclick="signCustomMessage()" disabled>Sign Message</button>
    <div id="custom-output" class="output" style="margin-top: 10px;">Initialize SDK and create keys first...</div>
  </div>

  <div class="demo-section">
    <h2>5. Export Public Keys</h2>
    <button id="export-keys-btn" onclick="exportPublicKeys()" disabled>Export Public Keys</button>
    <button id="download-keys-btn" onclick="downloadKeys()" disabled style="display:none;">Download JSON</button>
    <div id="export-output" class="output" style="margin-top: 10px;">Create keys first...</div>
  </div>

  <div class="demo-section">
    <h2>6. Verify External Signature</h2>
    <div style="margin: 10px 0;">
      <label for="verify-message">Message:</label><br>
      <textarea id="verify-message" placeholder="Enter the original message that was signed..." style="width: 100%; min-height: 60px; padding: 10px; border: 1px solid #bdc3c7; border-radius: 5px; font-family: inherit;" disabled></textarea>
    </div>
    <div style="margin: 10px 0;">
      <label>Algorithm:</label><br>
      <button id="verify-algo-ecdsa-btn" onclick="selectVerifyAlgorithm('ecdsa')" disabled style="background: #3498db;">ECDSA</button>
      <button id="verify-algo-mldsa-btn" onclick="selectVerifyAlgorithm('mldsa')" disabled style="background: #95a5a6;">ML-DSA</button>
    </div>
    <div style="margin: 10px 0;">
      <label for="verify-pubkey">Public Key (Hex):</label><br>
      <textarea id="verify-pubkey" placeholder="Paste the public key in hexadecimal format..." style="width: 100%; min-height: 60px; padding: 10px; border: 1px solid #bdc3c7; border-radius: 5px; font-family: 'Courier New', monospace; font-size: 12px;" disabled></textarea>
    </div>
    <div style="margin: 10px 0;">
      <label for="verify-signature">Signature (Hex):</label><br>
      <textarea id="verify-signature" placeholder="Paste the signature in hexadecimal format..." style="width: 100%; min-height: 60px; padding: 10px; border: 1px solid #bdc3c7; border-radius: 5px; font-family: 'Courier New', monospace; font-size: 12px;" disabled></textarea>
    </div>
    <button id="verify-sig-btn" onclick="verifyExternalSignature()" disabled>Verify Signature</button>
    <button onclick="loadVerifyExample()" disabled id="load-example-btn" style="background: #95a5a6;">Load Example</button>
    <div id="verify-output" class="output" style="margin-top: 10px;">Initialize SDK first...</div>
  </div>

  <div class="demo-section">
    <h2>7. Browser Key Storage</h2>
    <div class="stats" style="margin-bottom: 15px;">
      <div class="stat-card" style="background: #ecf0f1;">
        <div class="stat-value" id="stored-keys-count">0</div>
        <div class="stat-label">Keys in Storage</div>
      </div>
      <div class="stat-card" style="background: #ecf0f1;">
        <div class="stat-value" id="storage-size">0 bytes</div>
        <div class="stat-label">Storage Used</div>
      </div>
    </div>
    <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
      <p style="font-size: 13px; color: #856404; margin: 0;"><strong>‚ö†Ô∏è Demo Only:</strong> This demonstrates browser storage capabilities. In production, private keys should never be stored in localStorage.</p>
    </div>
    <button id="save-keys-btn" onclick="saveKeys()" disabled>Save Keys to Storage</button>
    <button id="load-storage-btn" onclick="loadStorage()">Reload Storage</button>
    <button id="clear-storage-btn" onclick="clearStorage()" disabled>Clear Storage</button>
    <div id="storage-output" class="output" style="margin-top: 10px;">Click "Reload Storage" to check for stored keys...</div>
  </div>

  <div class="demo-section">
    <h2>8. Key Management</h2>
    <button id="list-keys-btn" onclick="listKeys()" disabled>List All Keys</button>
    <button id="rotate-keys-btn" onclick="rotateKeys()" disabled>Rotate Agent Keys</button>
    <button id="profile-btn" onclick="getProfile()" disabled>Get Crypto Profile</button>
    <div id="mgmt-output" class="output" style="margin-top: 10px;">Create keys first...</div>
  </div>

  <div class="demo-section">
    <h2>9. Performance Test</h2>
    <button id="perf-test-btn" onclick="runPerformanceTest()" disabled>Run Performance Test</button>
    <div id="perf-output" class="output" style="margin-top: 10px;">Initialize SDK first...</div>
  </div>

  <!-- Load the SDK bundle from CDN -->
  <script src="https://unpkg.com/@smartledger/keys@1.5.1/dist/lumen-keys.min.js"></script>

  <script>
    // Global variables
    let sdk = null;
    let ecdsaKeyId = null;
    let mldsaKeyId = null;
    let stats = {
      keysCreated: 0,
      signaturesCreated: 0,
      verifications: 0
    };
    let selectedAlgorithm = 'both';
    let verifyAlgorithm = 'ecdsa';
    let exportedKeys = {};
    const STORAGE_KEY = 'smartledger-pq-keys';

    function updateStats() {
      document.getElementById('keys-created').textContent = stats.keysCreated;
      document.getElementById('signatures-created').textContent = stats.signaturesCreated;
      document.getElementById('verifications').textContent = stats.verifications;
    }

    function log(element, message, type = 'info') {
      const output = document.getElementById(element);
      const timestamp = new Date().toLocaleTimeString();
      const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
      output.innerHTML += `<span class="${className}">[${timestamp}]</span> ${message}\n`;
      output.scrollTop = output.scrollHeight;
    }

    async function initializeSDK() {
      const btn = document.getElementById('init-btn');
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> Initializing...';

      const output = document.getElementById('init-output');
      output.innerHTML = '';

      try {
        log('init-output', 'Creating KeySDK instance...', 'info');
        sdk = await LumenKeys.createKeySDK();

        log('init-output', '‚úÖ SDK initialized successfully!', 'success');
        log('init-output', 'Available features:', 'info');
        log('init-output', '  ‚Ä¢ ECDSA signatures (secp256k1)', 'info');
        log('init-output', '  ‚Ä¢ ML-DSA signatures (Post-Quantum)', 'info');
        log('init-output', '  ‚Ä¢ Hybrid signing support', 'info');
        log('init-output', '  ‚Ä¢ Key lifecycle management', 'info');

        // Enable other buttons
        document.getElementById('create-ecdsa-btn').disabled = false;
        document.getElementById('create-mldsa-btn').disabled = false;
        document.getElementById('perf-test-btn').disabled = false;
        document.getElementById('custom-message').disabled = false;
        document.getElementById('verify-message').disabled = false;
        document.getElementById('verify-pubkey').disabled = false;
        document.getElementById('verify-signature').disabled = false;
        document.getElementById('verify-algo-ecdsa-btn').disabled = false;
        document.getElementById('verify-algo-mldsa-btn').disabled = false;
        document.getElementById('load-example-btn').disabled = false;

        btn.textContent = '‚úÖ Initialized';
        btn.style.background = '#2ecc71';
      } catch (error) {
        log('init-output', `‚ùå Initialization failed: ${error.message}`, 'error');
        btn.disabled = false;
        btn.textContent = 'Retry';
      }
    }

    async function createECDSAKey() {
      try {
        log('keys-output', 'Creating ECDSA key...', 'info');

        const keyRecord = await sdk.createKey('BrowserAgent', {
          primarySignatureSuite: 'bsv-ecdsa-secp256k1'
        });

        ecdsaKeyId = keyRecord.meta.keyId;
        stats.keysCreated++;
        updateStats();

        log('keys-output', `‚úÖ ECDSA key created!`, 'success');
        log('keys-output', `   Key ID: ${keyRecord.meta.keyId}`, 'info');
        log('keys-output', `   Suite: ${keyRecord.meta.suiteId}`, 'info');
        const hex = Array.from(keyRecord.publicKey.slice(0, 16)).map(b => b.toString(16).padStart(2, '0')).join('');
        log('keys-output', `   Public Key (first 16 bytes): ${hex}...`, 'info');

        enableSigningButtons();
      } catch (error) {
        log('keys-output', `‚ùå Error: ${error.message}`, 'error');
      }
    }

    // ‚úÖ FIXED: missing closing braces + missing catch
    async function createMLDSAKey() {
      try {
        // Get selected variant
        const variantSelect = document.getElementById('ml-dsa-variant');
        const variant = variantSelect ? variantSelect.value : 'ml-dsa-65';

        const variantNames = {
          'ml-dsa-44': 'ML-DSA-44 (Level 2, fastest)',
          'ml-dsa-65': 'ML-DSA-65 (Level 3, balanced)',
          'ml-dsa-87': 'ML-DSA-87 (Level 5, maximum security)'
        };

        log('keys-output', `Creating ${variantNames[variant]} key...`, 'info');
        log('keys-output', '‚è≥ Initializing WASM module...', 'info');

        const keyRecord = await sdk.createKey('BrowserAgent', {
          primarySignatureSuite: variant
        });

        mldsaKeyId = keyRecord.meta.keyId;
        stats.keysCreated++;
        updateStats();

        log('keys-output', `‚úÖ ML-DSA key created!`, 'success');
        log('keys-output', `   Key ID: ${keyRecord.meta.keyId}`, 'info');
        log('keys-output', `   Suite: ${keyRecord.meta.suiteId}`, 'info');
        log('keys-output', `   Public Key Size: ${keyRecord.publicKey.length} bytes`, 'info');
        log('keys-output', `   This is QUANTUM-RESISTANT! üõ°Ô∏è`, 'success');

        enableSigningButtons();
      } catch (error) {
        log('keys-output', `‚ùå Error: ${error.message}`, 'error');
      }
    }

    // Character counter for custom message
    document.addEventListener('DOMContentLoaded', () => {
      const textarea = document.getElementById('custom-message');
      if (textarea) {
        textarea.addEventListener('input', (e) => {
          const text = e.target.value;
          const bytes = new TextEncoder().encode(text).length;
          document.getElementById('message-length').textContent = `${text.length} characters ‚Ä¢ ${bytes} bytes`;
        });
      }
      loadStorage();
    });

    function selectAlgorithm(algo) {
      selectedAlgorithm = algo;
      updateAlgorithmButtons();
    }

    function updateAlgorithmButtons() {
      const ecdsaBtn = document.getElementById('algo-ecdsa-btn');
      const mldsaBtn = document.getElementById('algo-mldsa-btn');
      const bothBtn = document.getElementById('algo-both-btn');

      ecdsaBtn.style.background = selectedAlgorithm === 'ecdsa' ? '#3498db' : '#95a5a6';
      mldsaBtn.style.background = selectedAlgorithm === 'mldsa' ? '#2ecc71' : '#95a5a6';
      bothBtn.style.background = selectedAlgorithm === 'both' ? '#9b59b6' : '#95a5a6';
    }

    function selectVerifyAlgorithm(algo) {
      verifyAlgorithm = algo;
      const ecdsaBtn = document.getElementById('verify-algo-ecdsa-btn');
      const mldsaBtn = document.getElementById('verify-algo-mldsa-btn');

      ecdsaBtn.style.background = verifyAlgorithm === 'ecdsa' ? '#3498db' : '#95a5a6';
      mldsaBtn.style.background = verifyAlgorithm === 'mldsa' ? '#2ecc71' : '#95a5a6';
    }

    async function signCustomMessage() {
      const message = document.getElementById('custom-message').value;
      if (!message.trim()) {
        alert('Please enter a message to sign');
        return;
      }

      const output = document.getElementById('custom-output');
      output.innerHTML = '';

      try {
        const messageBytes = new TextEncoder().encode(message);
        log('custom-output', `üìù Message: "${message}"`, 'info');
        log('custom-output', `   Size: ${messageBytes.length} bytes\n`, 'info');

        // Sign with ECDSA
        if ((selectedAlgorithm === 'ecdsa' || selectedAlgorithm === 'both') && ecdsaKeyId) {
          log('custom-output', 'üîê Signing with ECDSA...', 'info');
          const startSign = performance.now();
          const signature = await sdk.signWithKey(ecdsaKeyId, messageBytes);
          const signTime = (performance.now() - startSign).toFixed(2);

          stats.signaturesCreated++;
          updateStats();

          log('custom-output', `‚úÖ ECDSA signature created in ${signTime}ms`, 'success');
          log('custom-output', `   Size: ${signature.length} bytes`, 'info');
          const hex = Array.from(signature.slice(0, 32)).map(b => b.toString(16).padStart(2, '0')).join('');
          log('custom-output', `   Hex: ${hex}...\n`, 'info');

          // Verify
          const startVerify = performance.now();
          const isValid = await sdk.verifySignature(ecdsaKeyId, messageBytes, signature);
          const verifyTime = (performance.now() - startVerify).toFixed(2);
          stats.verifications++;
          updateStats();
          log('custom-output', `${isValid ? '‚úÖ' : '‚ùå'} Verification: ${isValid ? 'PASSED' : 'FAILED'} (${verifyTime}ms)\n`, isValid ? 'success' : 'error');
        }

        // Sign with ML-DSA
        if ((selectedAlgorithm === 'mldsa' || selectedAlgorithm === 'both') && mldsaKeyId) {
          log('custom-output', 'üõ°Ô∏è Signing with ML-DSA (Post-Quantum)...', 'info');
          const startSign = performance.now();
          const signature = await sdk.signWithKey(mldsaKeyId, messageBytes);
          const signTime = (performance.now() - startSign).toFixed(2);

          stats.signaturesCreated++;
          updateStats();

          log('custom-output', `‚úÖ ML-DSA signature created in ${signTime}ms`, 'success');
          log('custom-output', `   Size: ${signature.length} bytes`, 'info');
          const hex = Array.from(signature.slice(0, 32)).map(b => b.toString(16).padStart(2, '0')).join('');
          log('custom-output', `   Hex: ${hex}...\n`, 'info');

          // Verify
          const startVerify = performance.now();
          const isValid = await sdk.verifySignature(mldsaKeyId, messageBytes, signature);
          const verifyTime = (performance.now() - startVerify).toFixed(2);
          stats.verifications++;
          updateStats();
          log('custom-output', `${isValid ? '‚úÖ' : '‚ùå'} Verification: ${isValid ? 'PASSED' : 'FAILED'} (${verifyTime}ms)\n`, isValid ? 'success' : 'error');
        }
      } catch (error) {
        log('custom-output', `‚ùå Error: ${error.message}`, 'error');
      }
    }

    async function exportPublicKeys() {
      const output = document.getElementById('export-output');
      output.innerHTML = '';
      exportedKeys = {};

      try {
        if (ecdsaKeyId) {
          log('export-output', 'üì§ Exporting ECDSA public key...', 'info');
          const pubKey = await sdk.getPublicKey(ecdsaKeyId);
          const hex = Array.from(pubKey).map(b => b.toString(16).padStart(2, '0')).join('');
          exportedKeys.ecdsa = hex;
          log('export-output', `‚úÖ ECDSA Public Key (${pubKey.length} bytes):`, 'success');
          log('export-output', `   ${hex.substring(0, 64)}...`, 'info');
        }

        if (mldsaKeyId) {
          log('export-output', '\nüì§ Exporting ML-DSA public key...', 'info');
          const pubKey = await sdk.getPublicKey(mldsaKeyId);
          const hex = Array.from(pubKey).map(b => b.toString(16).padStart(2, '0')).join('');
          exportedKeys.mldsa = hex;
          log('export-output', `‚úÖ ML-DSA Public Key (${pubKey.length} bytes):`, 'success');
          log('export-output', `   ${hex.substring(0, 64)}...`, 'info');
        }

        log('export-output', '\n‚úÖ Public keys exported successfully', 'success');
        log('export-output', 'üí° These can be shared for signature verification', 'info');

        document.getElementById('download-keys-btn').style.display = 'inline-block';
        document.getElementById('download-keys-btn').disabled = false;
      } catch (error) {
        log('export-output', `‚ùå Error: ${error.message}`, 'error');
      }
    }

    function downloadKeys() {
      const data = {
        exported: new Date().toISOString(),
        keys: exportedKeys
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `smartledger-pq-keys-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
      log('export-output', '\n‚úÖ Public keys downloaded as JSON', 'success');
    }

    async function verifyExternalSignature() {
      const message = document.getElementById('verify-message').value;
      const publicKeyHex = document.getElementById('verify-pubkey').value;
      const signatureHex = document.getElementById('verify-signature').value;

      if (!message || !publicKeyHex || !signatureHex) {
        alert('Please fill in all fields');
        return;
      }

      const output = document.getElementById('verify-output');
      output.innerHTML = '';

      try {
        log('verify-output', 'üîç Starting signature verification...', 'info');

        const messageBytes = new TextEncoder().encode(message);
        log('verify-output', `üìù Message: "${message}" (${messageBytes.length} bytes)`, 'info');

        const publicKey = hexToUint8Array(publicKeyHex);
        log('verify-output', `üîë Public key: ${publicKey.length} bytes`, 'info');

        const signature = hexToUint8Array(signatureHex);
        log('verify-output', `‚úçÔ∏è Signature: ${signature.length} bytes`, 'info');

        log('verify-output', `\nüì• Importing ${verifyAlgorithm.toUpperCase()} public key...`, 'info');
        const keyId = await sdk.importPublicKey(publicKey, verifyAlgorithm);
        log('verify-output', `‚úÖ Key imported with ID: ${keyId}`, 'success');

        log('verify-output', '\nüîê Verifying signature...', 'info');
        const startVerify = performance.now();
        const isValid = await sdk.verifySignature(keyId, messageBytes, signature);
        const verifyTime = (performance.now() - startVerify).toFixed(2);

        if (isValid) {
          log('verify-output', `‚úÖ SIGNATURE VALID - Verified in ${verifyTime}ms`, 'success');
          log('verify-output', 'üéâ The signature is authentic and matches the message!', 'success');
        } else {
          log('verify-output', `‚ùå SIGNATURE INVALID - Checked in ${verifyTime}ms`, 'error');
          log('verify-output', '‚ö†Ô∏è The signature does not match the message or key', 'error');
        }

        log('verify-output', `\nüìä Algorithm: ${verifyAlgorithm.toUpperCase()}`, 'info');
        log('verify-output', `‚è±Ô∏è Verification time: ${verifyTime}ms`, 'info');

      } catch (error) {
        log('verify-output', `‚ùå Verification error: ${error.message}`, 'error');
      }
    }

    function hexToUint8Array(hex) {
      const cleanHex = hex.replace(/[^0-9a-fA-F]/g, '');
      const bytes = new Uint8Array(cleanHex.length / 2);
      for (let i = 0; i < cleanHex.length; i += 2) {
        bytes[i / 2] = parseInt(cleanHex.substr(i, 2), 16);
      }
      return bytes;
    }

    function loadVerifyExample() {
      document.getElementById('verify-message').value = 'Hello from the browser! üåê';
      log('verify-output', 'üí° Example message loaded - Create keys and export to get actual values', 'info');
    }

    async function saveKeys() {
      if (!sdk) return;

      const output = document.getElementById('storage-output');
      output.innerHTML = '';

      try {
        const keysToStore = [];

        if (ecdsaKeyId) {
          log('storage-output', 'üíæ Saving ECDSA key...', 'info');
          const publicKey = await sdk.getPublicKey(ecdsaKeyId);
          const hex = Array.from(publicKey).map(b => b.toString(16).padStart(2, '0')).join('');
          keysToStore.push({
            id: ecdsaKeyId,
            algorithm: 'ECDSA',
            publicKey: hex,
            created: new Date().toISOString()
          });
          log('storage-output', '‚úÖ ECDSA key saved', 'success');
        }

        if (mldsaKeyId) {
          log('storage-output', 'üíæ Saving ML-DSA key...', 'info');
          const publicKey = await sdk.getPublicKey(mldsaKeyId);
          const hex = Array.from(publicKey).map(b => b.toString(16).padStart(2, '0')).join('');
          keysToStore.push({
            id: mldsaKeyId,
            algorithm: 'ML-DSA',
            publicKey: hex,
            created: new Date().toISOString()
          });
          log('storage-output', '‚úÖ ML-DSA key saved', 'success');
        }

        localStorage.setItem(STORAGE_KEY, JSON.stringify(keysToStore));
        log('storage-output', `\n‚úÖ Saved ${keysToStore.length} key(s) to browser storage`, 'success');
        log('storage-output', 'üí° Keys persist across page refreshes', 'info');

        loadStorage();
      } catch (error) {
        log('storage-output', `‚ùå Error: ${error.message}`, 'error');
      }
    }

    function loadStorage() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        let keys = [];

        if (stored) {
          keys = JSON.parse(stored);
          document.getElementById('storage-output').innerHTML = '';
          log('storage-output', `üìÇ Loaded ${keys.length} key(s) from browser storage`, 'success');

          keys.forEach((key, index) => {
            log('storage-output', `\n${index + 1}. ${key.algorithm}`, 'info');
            log('storage-output', `   ID: ${key.id}`, 'info');
            log('storage-output', `   Created: ${new Date(key.created).toLocaleString()}`, 'info');
            log('storage-output', `   Public Key: ${key.publicKey.substring(0, 64)}...`, 'info');
          });
        } else {
          document.getElementById('storage-output').innerHTML = '';
          log('storage-output', 'üìÇ No keys found in storage', 'info');
        }

        document.getElementById('stored-keys-count').textContent = keys.length;

        const bytes = stored ? new Blob([stored]).size : 0;
        const sizeText = bytes < 1024 ? `${bytes} bytes` : `${(bytes / 1024).toFixed(2)} KB`;
        document.getElementById('storage-size').textContent = sizeText;

        document.getElementById('clear-storage-btn').disabled = keys.length === 0;
      } catch (error) {
        log('storage-output', `‚ùå Error loading keys: ${error.message}`, 'error');
      }
    }

    function clearStorage() {
      localStorage.removeItem(STORAGE_KEY);
      document.getElementById('storage-output').innerHTML = '';
      log('storage-output', 'üóëÔ∏è Storage cleared', 'success');
      loadStorage();
    }

    // ‚úÖ FIXED: removed stray extra "}" that was here in your original
    function enableSigningButtons() {
      if (ecdsaKeyId || mldsaKeyId) {
        document.getElementById('sign-verify-btn').disabled = false;
        document.getElementById('list-keys-btn').disabled = false;
        document.getElementById('rotate-keys-btn').disabled = false;
        document.getElementById('profile-btn').disabled = false;
        document.getElementById('sign-custom-btn').disabled = false;
        document.getElementById('export-keys-btn').disabled = false;
        document.getElementById('save-keys-btn').disabled = false;
      }
      if (ecdsaKeyId && mldsaKeyId) {
        document.getElementById('sign-all-btn').disabled = false;
      }
      if (ecdsaKeyId) {
        document.getElementById('algo-ecdsa-btn').disabled = false;
      }
      if (mldsaKeyId) {
        document.getElementById('algo-mldsa-btn').disabled = false;
      }
      if (ecdsaKeyId && mldsaKeyId) {
        document.getElementById('algo-both-btn').disabled = false;
      }
      updateAlgorithmButtons();
    }

    async function signAndVerify() {
      const output = document.getElementById('sign-output');
      output.innerHTML = '';

      try {
        const keyId = ecdsaKeyId || mldsaKeyId;
        const message = new TextEncoder().encode('Hello from the browser! üåê');

        log('sign-output', `Signing message with key ${keyId}...`, 'info');

        const startSign = performance.now();
        const signature = await sdk.signWithKey(keyId, message);
        const signTime = (performance.now() - startSign).toFixed(2);

        stats.signaturesCreated++;
        updateStats();

        log('sign-output', `‚úÖ Signature created in ${signTime}ms`, 'success');
        log('sign-output', `   Signature size: ${signature.length} bytes`, 'info');
        const hex = Array.from(signature.slice(0, 32)).map(b => b.toString(16).padStart(2, '0')).join('');
        log('sign-output', `   Signature (first 32 bytes hex): ${hex}...`, 'info');

        log('sign-output', '\nVerifying signature...', 'info');

        const startVerify = performance.now();
        const isValid = await sdk.verifySignature(keyId, message, signature);
        const verifyTime = (performance.now() - startVerify).toFixed(2);

        stats.verifications++;
        updateStats();

        if (isValid) {
          log('sign-output', `‚úÖ Signature verified in ${verifyTime}ms`, 'success');
        } else {
          log('sign-output', `‚ùå Signature verification failed!`, 'error');
        }
      } catch (error) {
        log('sign-output', `‚ùå Error: ${error.message}`, 'error');
      }
    }

    async function signWithBoth() {
      const output = document.getElementById('sign-output');
      output.innerHTML = '';

      try {
        const message = new TextEncoder().encode('Hybrid signature test message');

        log('sign-output', 'Creating signatures with both algorithms...', 'info');

        // ECDSA
        log('sign-output', '\nüìù ECDSA Signing...', 'info');
        const ecdsaStart = performance.now();
        const ecdsaSig = await sdk.signWithKey(ecdsaKeyId, message);
        const ecdsaTime = (performance.now() - ecdsaStart).toFixed(2);
        stats.signaturesCreated++;

        log('sign-output', `‚úÖ ECDSA: ${ecdsaTime}ms, ${ecdsaSig.length} bytes`, 'success');

        // ML-DSA
        log('sign-output', '\nüìù ML-DSA Signing...', 'info');
        const mldsaStart = performance.now();
        const mldsaSig = await sdk.signWithKey(mldsaKeyId, message);
        const mldsaTime = (performance.now() - mldsaStart).toFixed(2);
        stats.signaturesCreated++;

        log('sign-output', `‚úÖ ML-DSA: ${mldsaTime}ms, ${mldsaSig.length} bytes`, 'success');

        // Compare
        log('sign-output', '\nüìä Comparison:', 'info');
        log('sign-output', `   ECDSA: ${ecdsaTime}ms, ${ecdsaSig.length} bytes`, 'info');
        log('sign-output', `   ML-DSA: ${mldsaTime}ms, ${mldsaSig.length} bytes`, 'info');
        log('sign-output', `   Size ratio: ${(mldsaSig.length / ecdsaSig.length).toFixed(2)}x`, 'info');

        updateStats();
      } catch (error) {
        log('sign-output', `‚ùå Error: ${error.message}`, 'error');
      }
    }

    async function listKeys() {
      const output = document.getElementById('mgmt-output');
      output.innerHTML = '';

      try {
        log('mgmt-output', 'Listing keys for BrowserAgent...', 'info');

        const keys = await sdk.listKeysForAgent('BrowserAgent');

        log('mgmt-output', `\n‚úÖ Found ${keys.length} key(s):`, 'success');

        keys.forEach((key, index) => {
          log('mgmt-output', `\n${index + 1}. ${key.meta.keyId}`, 'info');
          log('mgmt-output', `   Suite: ${key.meta.suiteId}`, 'info');
          log('mgmt-output', `   Usage: ${key.meta.usage.join(', ')}`, 'info');
          log('mgmt-output', `   Status: ${key.meta.status}`, 'info');
          log('mgmt-output', `   Public Key Size: ${key.publicKey.length} bytes`, 'info');
        });
      } catch (error) {
        log('mgmt-output', `‚ùå Error: ${error.message}`, 'error');
      }
    }

    async function rotateKeys() {
      const output = document.getElementById('mgmt-output');
      output.innerHTML = '';

      try {
        log('mgmt-output', 'Rotating keys for BrowserAgent...', 'info');
        log('mgmt-output', 'Creating new keys...', 'info');

        const newKeys = [];

        if (ecdsaKeyId) {
          const newEcdsa = await sdk.createKey('BrowserAgent', {
            primarySignatureSuite: 'bsv-ecdsa-secp256k1'
          });
          newKeys.push(newEcdsa);
          ecdsaKeyId = newEcdsa.meta.keyId;
          stats.keysCreated++;
        }

        if (mldsaKeyId) {
          const newMldsa = await sdk.createKey('BrowserAgent', {
            primarySignatureSuite: 'ml-dsa-65'
          });
          newKeys.push(newMldsa);
          mldsaKeyId = newMldsa.meta.keyId;
          stats.keysCreated++;
        }

        updateStats();

        log('mgmt-output', `\n‚úÖ Created ${newKeys.length} new key(s):`, 'success');

        newKeys.forEach((key, index) => {
          log('mgmt-output', `\n${index + 1}. ${key.meta.keyId}`, 'info');
          log('mgmt-output', `   Suite: ${key.meta.suiteId}`, 'info');
        });

        log('mgmt-output', '\n‚úÖ Keys rotated successfully', 'success');
      } catch (error) {
        log('mgmt-output', `‚ùå Error: ${error.message}`, 'error');
      }
    }

    async function getProfile() {
      const output = document.getElementById('mgmt-output');
      output.innerHTML = '';

      try {
        log('mgmt-output', 'Getting key profile...', 'info');

        const keys = await sdk.listKeysForAgent('BrowserAgent', true);
        const activeKeys = keys.filter(k => k.meta.status === 'active');

        log('mgmt-output', '\n‚úÖ Active Keys Profile:', 'success');
        log('mgmt-output', `   Total active keys: ${activeKeys.length}`, 'info');

        const hasEcdsa = activeKeys.some(k => k.meta.suiteId === 'bsv-ecdsa-secp256k1');
        const hasMldsa = activeKeys.some(k => k.meta.suiteId === 'ml-dsa-65');

        if (hasEcdsa && hasMldsa) {
          log('mgmt-output', '\nüõ°Ô∏è Hybrid mode: Maximum security!', 'success');
          log('mgmt-output', '   ‚Ä¢ Classical ECDSA for current compatibility', 'info');
          log('mgmt-output', '   ‚Ä¢ Post-quantum ML-DSA for future-proofing', 'info');
        } else if (hasMldsa) {
          log('mgmt-output', '\nüõ°Ô∏è Post-quantum only: Future-ready!', 'success');
        } else if (hasEcdsa) {
          log('mgmt-output', '\nüìù Classical only: Standard ECDSA', 'info');
        } else {
          log('mgmt-output', '\n‚ö†Ô∏è No active keys', 'info');
        }
      } catch (error) {
        log('mgmt-output', `‚ùå Error: ${error.message}`, 'error');
      }
    }

    async function runPerformanceTest() {
      const output = document.getElementById('perf-output');
      output.innerHTML = '';
      const btn = document.getElementById('perf-test-btn');
      btn.disabled = true;

      try {
        log('perf-output', 'üèÉ Running performance test...', 'info');
        log('perf-output', 'Testing 10 key creations and 100 sign/verify operations\n', 'info');

        const message = new TextEncoder().encode('Performance test message');
        const iterations = 100;

        // Test ECDSA
        log('perf-output', 'üìä ECDSA Performance:', 'info');

        const ecdsaKeyStart = performance.now();
        for (let i = 0; i < 10; i++) {
          await sdk.createKey(`PerfAgent${i}`, { primarySignatureSuite: 'bsv-ecdsa-secp256k1' });
        }
        const ecdsaKeyTime = (performance.now() - ecdsaKeyStart).toFixed(2);
        log('perf-output', `   Key creation (10x): ${ecdsaKeyTime}ms (${(ecdsaKeyTime / 10).toFixed(2)}ms avg)`, 'info');

        const testKey = await sdk.createKey('PerfTest', { primarySignatureSuite: 'bsv-ecdsa-secp256k1' });

        const ecdsaSignStart = performance.now();
        for (let i = 0; i < iterations; i++) {
          await sdk.signWithKey(testKey.meta.keyId, message);
        }
        const ecdsaSignTime = (performance.now() - ecdsaSignStart).toFixed(2);
        log('perf-output', `   Signing (${iterations}x): ${ecdsaSignTime}ms (${(ecdsaSignTime / iterations).toFixed(2)}ms avg)`, 'info');

        const sig = await sdk.signWithKey(testKey.meta.keyId, message);
        const ecdsaVerifyStart = performance.now();
        for (let i = 0; i < iterations; i++) {
          await sdk.verifySignature(testKey.meta.keyId, message, sig);
        }
        const ecdsaVerifyTime = (performance.now() - ecdsaVerifyStart).toFixed(2);
        log('perf-output', `   Verification (${iterations}x): ${ecdsaVerifyTime}ms (${(ecdsaVerifyTime / iterations).toFixed(2)}ms avg)`, 'success');

        log('perf-output', '\n‚úÖ Performance test complete!', 'success');
        log('perf-output', `\nüí° Throughput:`, 'info');
        log('perf-output', `   ‚Ä¢ ${(iterations * 1000 / ecdsaSignTime).toFixed(0)} signatures/sec`, 'info');
        log('perf-output', `   ‚Ä¢ ${(iterations * 1000 / ecdsaVerifyTime).toFixed(0)} verifications/sec`, 'info');

        btn.disabled = false;
      } catch (error) {
        log('perf-output', `‚ùå Error: ${error.message}`, 'error');
        btn.disabled = false;
      }
    }
  </script>
</body>
</html>
